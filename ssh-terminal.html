<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH Terminal - LovelyRes</title>
    <link rel="stylesheet" href="/src/css/base.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            font-family: var(--font-family);
            overflow: hidden;
        }

        #app {
            width: 100vw;
            height: 100vh;
        }

        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .control-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            -webkit-app-region: no-drag;
        }

        .control-button:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .control-button.minimize-btn:hover {
            background: #f39c12;
            color: white;
        }

        .control-button.maximize-btn:hover {
            background: #27ae60;
            color: white;
        }

        .control-button.close-btn:hover {
            background: #e74c3c;
            color: white;
        }

        /* è°ƒæ•´å‘½ä»¤å»ºè®®é¢æ¿ä½ç½®åˆ°å³ä¾§ */
        .command-suggestions-panel {
            left: auto !important;
            right: 20px !important;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        .command-suggestions-panel {
            animation: slideInRight 0.2s ease-out !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- è‡ªå®šä¹‰æ ‡é¢˜æ ï¼ˆä»…åœ¨é macOS ä¸Šæ˜¾ç¤ºï¼‰ -->
        <div class="modern-title-bar" data-tauri-drag-region id="custom-title-bar">
            <div class="title-bar-left">
                <div class="app-logo">
                    <div class="logo-icon" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); width: 24px; height: 24px; border-radius: var(--border-radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                        SSH
                    </div>
                    <div class="app-info">
                        <div class="app-name" style="font-size: 14px;">SSH Terminal</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">LovelyRes</div>
                    </div>
                </div>
            </div>
            <div class="title-bar-right" id="window-controls-container">
                <!-- çª—å£æ§åˆ¶æŒ‰é’®å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ ï¼ˆé macOSï¼‰ -->
            </div>
        </div>

        <!-- SSHç»ˆç«¯å†…å®¹ -->
        <div id="ssh-terminal-content"></div>
    </div>

    <script type="module">
        import { createApp } from 'vue';
        import { invoke } from '@tauri-apps/api/core';
        import { getCurrentWebviewWindow } from '@tauri-apps/api/webviewWindow';
        import { listen } from '@tauri-apps/api/event';
        import { install } from '@icon-park/vue-next/es/all';
        import '@icon-park/vue-next/styles/index.css';
        import 'xterm/css/xterm.css';
        import SSHTerminal from '/src/components/SSHTerminal.vue';

        // æ£€æµ‹æ˜¯å¦ä¸º macOS
        const isMacOS = navigator.platform.toUpperCase().indexOf('MAC') >= 0;

        // æ ¹æ®å¹³å°è°ƒæ•´ç•Œé¢
        const customTitleBar = document.getElementById('custom-title-bar');
        const terminalContent = document.getElementById('ssh-terminal-content');

        if (isMacOS) {
            // macOS: éšè—è‡ªå®šä¹‰æ ‡é¢˜æ ï¼Œä½¿ç”¨åŸç”Ÿæ ‡é¢˜æ 
            if (customTitleBar) {
                customTitleBar.style.display = 'none';
            }
            if (terminalContent) {
                terminalContent.style.height = '100vh';
            }
        } else {
            // å…¶ä»–å¹³å°: æ˜¾ç¤ºè‡ªå®šä¹‰æ ‡é¢˜æ å’Œçª—å£æ§åˆ¶æŒ‰é’®
            if (terminalContent) {
                terminalContent.style.height = 'calc(100vh - 45px)';
            }

            const container = document.getElementById('window-controls-container');
            if (container) {
                container.innerHTML = `
                    <button class="control-button minimize-btn" onclick="minimizeWindow()" title="æœ€å°åŒ–">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <rect x="2" y="5.5" width="8" height="1"/>
                        </svg>
                    </button>
                    <button class="control-button maximize-btn" onclick="toggleMaximize()" title="æœ€å¤§åŒ–">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <rect x="2" y="2" width="8" height="8" stroke="currentColor" stroke-width="1" fill="none"/>
                        </svg>
                    </button>
                    <button class="control-button close-btn close" onclick="closeWindow()" title="å…³é—­">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <path d="M2.5 2.5L9.5 9.5M9.5 2.5L2.5 9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                `;
            }
        }

        // çª—å£æ§åˆ¶å‡½æ•°
        window.minimizeWindow = async () => {
            try {
                const window = getCurrentWebviewWindow();
                await window.minimize();
            } catch (error) {
                console.error('æœ€å°åŒ–çª—å£å¤±è´¥:', error);
            }
        };

        window.toggleMaximize = async () => {
            try {
                const window = getCurrentWebviewWindow();
                await window.toggleMaximize();
            } catch (error) {
                console.error('åˆ‡æ¢æœ€å¤§åŒ–çŠ¶æ€å¤±è´¥:', error);
            }
        };

        window.closeWindow = async () => {
            try {
                // æ¸…ç†æ‰€æœ‰SSHä¼šè¯
                await cleanupSSHSessions();

                const window = getCurrentWebviewWindow();
                await window.destroy();
            } catch (error) {
                console.error('å…³é—­çª—å£å¤±è´¥:', error);
            }
        };

        // æ¸…ç†SSHä¼šè¯
        async function cleanupSSHSessions() {
            try {
                // ä½¿ç”¨æ–°çš„å…¨å±€æ¸…ç†å‘½ä»¤ï¼Œä¸€æ¬¡æ€§å…³é—­æ‰€æœ‰ç»ˆç«¯ä¼šè¯
                const count = await invoke('ssh_close_all_terminal_sessions');
                console.log(`âœ… å·²æ¸…ç†æ‰€æœ‰SSHä¼šè¯ï¼Œå…± ${count} ä¸ª`);
            } catch (error) {
                console.error('âŒ æ¸…ç†SSHä¼šè¯æ—¶å‡ºé”™:', error);

                // å¦‚æœå…¨å±€æ¸…ç†å¤±è´¥ï¼Œå°è¯•é€ä¸ªæ¸…ç†ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
                try {
                    const terminals = document.querySelectorAll('[data-terminal-id]');
                    for (const terminal of terminals) {
                        const terminalId = terminal.getAttribute('data-terminal-id');
                        if (terminalId) {
                            try {
                                await invoke('ssh_close_terminal_session', { terminalId });
                                console.log('âœ… å·²æ¸…ç†SSHä¼šè¯:', terminalId);
                            } catch (error) {
                                console.warn('âš ï¸ æ¸…ç†SSHä¼šè¯å¤±è´¥:', terminalId, error);
                            }
                        }
                    }
                } catch (fallbackError) {
                    console.error('âŒ åå¤‡æ¸…ç†æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                }
            }
        }

        // ç›‘å¬çª—å£å…³é—­äº‹ä»¶
        window.addEventListener('beforeunload', async (event) => {
            await cleanupSSHSessions();
        });

        // ä¸»é¢˜ç®¡ç†
        async function initializeTheme() {
            try {
                // è·å–å½“å‰ä¸»é¢˜
                const themeSettings = await invoke('get_theme_settings');
                const currentTheme = themeSettings.current_theme || 'sakura';

                // åº”ç”¨ä¸»é¢˜
                applyTheme(currentTheme);

                // ç›‘å¬ä¸»é¢˜å˜æ›´äº‹ä»¶
                await listen('theme-changed', (event) => {
                    console.log('ğŸ¨ æ”¶åˆ°ä¸»é¢˜å˜æ›´äº‹ä»¶:', event.payload);
                    applyTheme(event.payload);
                });

                console.log('âœ… ä¸»é¢˜åˆå§‹åŒ–å®Œæˆ:', currentTheme);
            } catch (error) {
                console.error('âŒ ä¸»é¢˜åˆå§‹åŒ–å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤ä¸»é¢˜
                applyTheme('sakura');
            }
        }

        function applyTheme(theme) {
            const body = document.body;
            const html = document.documentElement;

            // è®¾ç½®data-themeå±æ€§
            body.setAttribute('data-theme', theme);
            html.setAttribute('data-theme', theme);

            // æ›´æ–°bodyç±»å
            body.classList.remove('light-theme', 'dark-theme', 'sakura-theme');
            body.classList.add(`${theme}-theme`);

            // åŠ¨æ€åŠ è½½ä¸»é¢˜CSSæ–‡ä»¶
            loadThemeCSS(theme);
        }

        function loadThemeCSS(theme) {
            // ç§»é™¤æ—§çš„ä¸»é¢˜CSS
            const existingThemeLink = document.querySelector('link[data-theme-css]');
            if (existingThemeLink) {
                existingThemeLink.remove();
            }

            // åŠ è½½æ–°çš„ä¸»é¢˜CSS
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `/src/css/themes/${theme}.css`;
            link.setAttribute('data-theme-css', 'true');
            document.head.appendChild(link);
        }

        // åˆå§‹åŒ–å­—ä½“è®¾ç½®
        async function initializeFontSettings() {
            try {
                console.log('ğŸ”¤ åˆå§‹åŒ–SSHç»ˆç«¯å­—ä½“è®¾ç½®...');

                // è¯»å–è®¾ç½®æ–‡ä»¶
                const settingsContent = await invoke('read_settings_file');
                if (settingsContent) {
                    const settings = JSON.parse(settingsContent);

                    // åº”ç”¨å…¨å±€å­—ä½“è®¾ç½®
                    if (settings.ui && settings.ui.globalFont && settings.ui.globalFont !== 'system') {
                        let fontFamily = settings.ui.globalFont;

                        // å¦‚æœå­—ä½“åç§°ä¸åŒ…å«å¼•å·ï¼Œè‡ªåŠ¨æ·»åŠ 
                        if (!fontFamily.includes("'") && !fontFamily.includes('"')) {
                            fontFamily = `'${fontFamily}', sans-serif`;
                        }

                        document.documentElement.style.setProperty('--font-family', fontFamily);
                        console.log('âœ… SSHç»ˆç«¯å·²åº”ç”¨å…¨å±€å­—ä½“:', fontFamily);
                    } else {
                        console.log('ğŸ“ SSHç»ˆç«¯ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“');
                    }
                } else {
                    console.log('ğŸ“ æœªæ‰¾åˆ°è®¾ç½®æ–‡ä»¶ï¼ŒSSHç»ˆç«¯ä½¿ç”¨é»˜è®¤å­—ä½“');
                }
            } catch (error) {
                console.error('âŒ SSHç»ˆç«¯å­—ä½“è®¾ç½®åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºVueåº”ç”¨ï¼Œç›´æ¥ä½¿ç”¨SSHTerminalç»„ä»¶ä½œä¸ºæ ¹ç»„ä»¶
        const app = createApp(SSHTerminal);

        // å®‰è£…IconParkå›¾æ ‡åº“
        install(app, 'icon'); // ä½¿ç”¨ 'icon' å‰ç¼€ï¼Œä¾‹å¦‚ icon-add-one

        // æŒ‚è½½åº”ç”¨åˆ°SSHç»ˆç«¯å†…å®¹åŒºåŸŸ
        app.mount('#ssh-terminal-content');

        // åˆå§‹åŒ–ä¸»é¢˜
        initializeTheme();

        // åˆå§‹åŒ–å­—ä½“è®¾ç½®
        initializeFontSettings();

        console.log('âœ… SSHç»ˆç«¯çª—å£å·²åˆå§‹åŒ–');
    </script>
</body>
</html>
